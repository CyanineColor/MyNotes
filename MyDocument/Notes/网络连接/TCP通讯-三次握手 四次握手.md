TCP建立连接的操作称为三次握手，具体步骤如下：

1. **第一次握手（Client → Server）**
    

客户端向服务器发送一个SYN（Synchronize Sequence Numbers，同步序列号）报文，标志位中的SYN被置为1，用于建立连接并同步序列号。其报文格式为：

cpp

复制

```cpp
SYN: 1 FIN: 0
```

客户端进入SYN-SENT（同步已发送）状态，等待服务器的响应。

2. **第二次挥手（Server → Client）**
    

服务器收到客户端的SYN报文后，发送一个SYN和ACK报文作为应答。其中，SYN用于同步服务器端的序列号，ACK用于确认收到客户端的SYN报文。其报文格式为：

cpp

复制

```cpp
SYN: 1 FIN: 0
```

服务器进入SYN-RECEIVED（同步收到）状态。客户端收到服务器的ACK报文后，确认服务器已经收到自己的连接请求，并且双方可以开始数据传输。

3. **第三次挥手（Client → Server）**
    

客户端发送一个ACK报文给服务器，用于确认收到服务器的SYN和ACK报文。其报文格式为：

cpp

复制

```cpp
SYN: 0 FIN: 0
```

客户端和服务器都进入ESTABLISHED（已建立连接）状态，此时连接建立成功，双方可以开始正常的数据传输。

在三次握手过程中，客户端和服务器通过交换SYN和ACK报文，同步了双方的序列号和确认号，确保了双方都已准备好进行数据传输。这种机制可以有效地避免错误的连接建立，提高通信的可靠性。

### 注意事项

- **TCP连接建立后**，客户端和服务器可以开始进行数据传输。在数据传输过程中，TCP协议会负责对数据进行分段、排序、确认和重传等操作，以确保数据的可靠传输。
    
- **在某些情况下**，如网络拥堵或数据包丢失，TCP连接的建立可能会失败。例如，客户端发送的SYN报文可能在网络中丢失，导致服务器无法收到并做出响应，此时客户端需要重新发送SYN报文，以尝试重新建立连接。

1. **TCP 连接的正常断开过程（四次挥手）及相关报文**
    
    - **第一次挥手（Client - > Server）** ：
        
        - 当客户端要主动断开连接时，会发送一个 FIN（Finish）报文，FIN 报文用来表示数据发送完毕，希望断开连接。其格式主要包括源 IP 地址、目的 IP 地址、源端口、目的端口等基本信息，同时会设置 FIN 标志位为 1。
            
        - 例如，假设客户端的源端口是 50000，服务器端口是 8080，那么这个 FIN 报文会从客户端的 50000 端口发送到服务器的 8080 端口。同时，会携带一个序列号（Seq），这个序列号是在 TCP 连接建立阶段初始序列号的基础上，经过数据传输等一系列操作后的当前序列号。
            
    - **第二次挥手（Server - > Client）** ：
        
        - 服务器接收到客户端的 FIN 报文后，会发送一个 ACK（Acknowledgment）报文作为应答。ACK 报文会设置 ACK 标志位为 1，其序列号（Seq）是服务器自己当前的序列号，而确认号（Ack）是客户端 FIN 报文序列号加 1。
            
        - 比如，如果客户端的 FIN 报文序列号是 1000，服务器会回复一个 ACK 报文，其确认号就是 1001，并且服务器的序列号是自己的当前序列号，假设是 1500。
            
    - **第三次挥手（Server - > Client）** ：
        
        - 服务器在发送完 ACK 报文后，也会主动发送一个 FIN 报文来表示自己要断开连接。这个 FIN 报文同样会设置 FIN 标志位为 1，序列号是服务器上次发送的序列号加 1（如果之前没有其他数据传输操作影响序列号的话）。
            
        - 以服务器之前的序列号 1500 为例，那么这个 FIN 报文的序列号可能是 1501。
            
    - **第四次挥手（Client - > Server）** ：
        
        - 客户端收到服务器的 FIN 报文后，会发送一个 ACK 报文作为应答。ACK 报文设置 ACK 标志位为 1，序列号是客户端自己当前的序列号，确认号是服务器 FIN 报文的序列号加 1。
            
        - 假设服务器的 FIN 报文序列号是 1501，客户端的 ACK 报文的确认号就是 1502，序列号是客户端自己当前的序列号，例如是 1001（因为之前客户端发送的 FIN 报文序列号是 1000，如果后续没有其他操作改变序列号，那么序列号可能是 1001）。
            
2. **特殊情况下的断开连接报文**
    
    - **RST（Reset）报文** ：
        
        - 当一方收到一个不期望的 TCP 报文段（例如，在连接已经处于关闭状态时收到了新的数据报文，或者收到的报文段的序列号、端口号等不符合当前连接情况），会发送一个 RST 报文来重置连接。
            
        - RST 报文会设置 RST 标志位为 1。例如，如果服务器收到一个源端口为 50000，目的端口为 8080，但序列号不符合服务器当前连接状态的报文，服务器会发送一个 RST 报文给客户端，其目的端口是客户端的源端口 50000，源端口是服务器的端口 8080，同时设置 RST 标志位为 1 来重置连接。
        - TCP 四次挥手的具体步骤如下：

3. **第一次挥手（Client → Server）** 客户端发送一个 FIN 报文给服务器，表示客户端已经没有数据要发送，希望断开连接。其报文格式为：
    

cpp

复制

```cpp
SYN: 0 FIN: 1
```

2. **第二次挥手（Server → Client）** 服务器收到客户端的 FIN 报文后，会发送一个 ACK 报文作为应答，确认收到客户端的断开连接请求。其报文格式为：
    

cpp

复制

```cpp
SYN: 0 FIN: 0
```

3. **第三次挥手（Server → Client）** 服务器在发送完 ACK 报文后，也会主动发送一个 FIN 报文给客户端，表示服务器也没有数据要发送，同意断开连接。其报文格式为：
    

cpp

复制

```cpp
SYN: 0 FIN: 1
```

4. **第四次挥手（Client → Server）** 客户端收到服务器的 FIN 报文后，会发送一个 ACK 报文作为应答，确认收到服务器的断开连接请求。其报文格式为：
    

cpp

复制

```cpp
SYN: 0 FIN: 0
```

以上就是 TCP 四次挥手的具体步骤。