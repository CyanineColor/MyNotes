```c#
//传图按钮按下
if (!GlobalVal.intStartThread)
{
    Thread.Sleep(10);
    UpdateListBox("开始上传");

    int FtpListIndex = 0;   //list中的数据的存储序号

    int intImageType = 0; // 0原图  1检测图

    //获取当前日期
    string strDate = GlobalVal.intTimeSelectMethod == 0 ? DateTime.Now.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) : strDate = dateTimePicker3.Value.ToString("yyyy-MM-dd") + strDayNight[GlobalVal.intDayNight];
    Stopwatch stopwatch = Stopwatch.StartNew(); // 创建并启动Stopwatch

    //在FTP上创建文件夹
    if (GlobalVal.intSaveModel == 0)
    {
        UpdateListBox("在FTP上创建文件夹");
        var stopwatch1 = Stopwatch.StartNew();

        List<string> allDirectories = [];
        foreach (var dataInfo in excelDataInfos)
        {
            List<string> pathParts = [];
            pathParts.Add(parts5[GlobalVal.intDataType]);
            if (GlobalVal.intDataType != 2)
            {
                pathParts.Add(GlobalVal.strMachineNum); // 机台编号
                pathParts.Add(parts3[GlobalVal.intRunningModel]); // 运行模式
            }
            pathParts.Add(strDate);
            pathParts.Add(dataInfo.DetectedType);
            pathParts.Add(dataInfo.OPResult);
            pathParts.Add(dataInfo.Location);
            var pathListItem = Path.Combine([.. pathParts]).SelectMany(path => new[] { $"{path}/原图", $"{path}/检测图" });
            allDirectories.AddRange(pathListItem);
        }

        // 生成所有需要创建的目录路径
        _ = allDirectories.Distinct().ToList();

        if (allDirectories.Any())
        {
            try
            {
                // 并行创建FTP目录（注意：需要确保FtpCheckDirectoryExist方法是线程安全的）
                Parallel.ForEach(allDirectories, directory =>
                {
                    FtpCheckDirectoryExist(directory);
                });

                var elapsedTime = stopwatch1.ElapsedMilliseconds;
                UpdateListBox($"FTP创建文件夹成功。耗时：{elapsedTime}ms");
                Txt($"FTP创建文件夹成功。耗时：{elapsedTime}ms", "Upload");
            }
            catch (Exception ex)
            {
                // 记录异常信息
                UpdateListBox($"FTP创建文件夹失败：{ex.Message}");
                Txt($"FTP创建文件夹失败：{ex.Message}", "Upload");
            }
        }
        else
        {
            UpdateListBox("没有需要创建的FTP文件夹");
            Txt("没有需要创建的FTP文件夹", "Upload");
        }

    }


    if (GlobalVal.intSelectSource == 1)
    {
        UpdateListBox("本地文件夹捞图");
        //去重，去空值
        excelDataInfos = [.. excelDataInfos?.Distinct()?.Where(p => !string.IsNullOrEmpty(p.Barcode))];
        if (excelDataInfos?.Count == 0) { continue; }
        //获取到文件信息
        Dictionary<ExcelDataInfo, List<string>> barcodePathInfos = FindFoldersByBarcode(strListSourcePath, excelDataInfos);



        int intExcelIndexNumber = 0;
        foreach (var barcodeInfo in barcodePathInfos)
        {
            ExcelDataInfo excelDataInfo = barcodeInfo.Key;
            List<string> barcodePaths = barcodeInfo.Value;
            if (barcodePaths == null || barcodePaths.Count == 0) { intExcelIndexNumber++; continue; }
            string strPrint1 = excelDataInfo.Barcode + " " + excelDataInfo.Location + "  " + excelDataInfo.DetectedType + "  " + excelDataInfo.OPResult + "  " + excelDataInfo.SelectedImgIndex + "  " + parts5[GlobalVal.intDataType];
            Task.Run(() =>
            {
                UpdateListBox(strPrint1);
            });


            List<FileInfo> fileNames = [];

            //循环查找不同路径下的SN存放图片
            foreach (var folderPath in barcodePaths)
            {
                DirectoryInfo directory = new(folderPath);
                // 获取所有JPG文件（不递归子文件夹）
                var jpgFiles = directory?.GetFiles("*.jpg")?.ToList();
                if (jpgFiles?.Count > 0)
                {
                    fileNames.AddRange(jpgFiles);
                    log.Info($"文件夹{folderPath}路径下JPG文件数量：{jpgFiles.Count}");
                }
            }
            log.Info($"对应路径文件夹条码信息：Code:{excelDataInfo.Barcode} Count:{fileNames?.Count} " +
                     $"Info:\n {JsonConvert.SerializeObject(fileNames?.Select(p => p.FullName))}");

            var uploadInfo = FilesUploading(fileNames, excelDataInfo);
            FtpListIndex += uploadInfo.Item3;
            intExcelIndexNumber++;
            Task.Run(() =>
            {
                UpdateProgress(intExcelIndexNumber, barcodePathInfos.Count());  // 在UI线程中更新进度条
            });

            //退出条件
            if (GlobalVal.intThreadStopWork)
            {
                break;
            }

        }
    }
    #region 新方法，可以用了
    else//数据库捞图
    {
        UpdateListBox("数据库捞图");
    }
    #endregion

    stopwatch.Stop(); // 停止Stopwatch
    UpdateListBox("完成个数：" + (FtpListIndex).ToString());
    Txt("完成个数：" + (FtpListIndex).ToString(), "upload");
    Txt("完成时间：" + stopwatch.ElapsedMilliseconds.ToString() + "ms", "upload");
    //更新界面
    this.Invoke(new Action(() =>
    {
        button6.Text = "开始传图";
        label11.Text = "完成时间：" + stopwatch.ElapsedMilliseconds.ToString() + "ms";
    }));
    GlobalVal.intStartThread = true;
    GlobalVal.intThreadStopWork = false;

}
```